services:
  fundamental-backend:
    build:
      context: ..
      dockerfile: infra/Dockerfile.backend
    container_name: fundamental-backend
    restart: unless-stopped
    environment:
      # backend authentication settings
      FUNDAMENTAL_JWT_SECRET: ${FUNDAMENTAL_JWT_SECRET:-youShouldChangeThis}
      FUNDAMENTAL_JWT_ALG: ${FUNDAMENTAL_JWT_ALG:-HS256}
      FUNDAMENTAL_JWT_EXPIRES_MIN: ${FUNDAMENTAL_JWT_EXPIRES_MIN:-131400} # 3 months
      FUNDAMENTAL_ALEMBIC_ENABLED: ${FUNDAMENTAL_ALEMBIC_ENABLED:-true}
      # Database URL - defaults to SQLite if postgres service is not available
      # Set FUNDAMENTAL_DATABASE_URL to use PostgreSQL, or leave unset for SQLite
      # Example PostgreSQL URL (uncomment and adjust if using postgres service):
      # FUNDAMENTAL_DATABASE_URL: postgresql+psycopg://${POSTGRES_USER:-admin}:${POSTGRES_PASSWORD:-admin123}@postgres:5432/${POSTGRES_DB:-fundamental}
      FUNDAMENTAL_DATABASE_URL: ${FUNDAMENTAL_DATABASE_URL:-}

      # library administration settings
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@example.com}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin123}

      # Key used for storing user-provided passwords and tokens.
      # You should change this.  DO NOT use this key in production.
      # Get a key from: https://fernet.utils.com/
      # Or generate a key with: `python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"`
      FUNDAMENTAL_FERNET_KEY: ${FUNDAMENTAL_FERNET_KEY:-EifxhGYj-u0JolSrDhBLqyIZSnoZCVKOAFQbuv70T08=}
      # !!! One more time: DO NOT USE THIS KEY IN PRODUCTION. !!!

      # Redis configuration for distributed workers (optional)
      # Set ENABLE_REDIS=false to disable Redis features
      # If Redis service is available, it will be used automatically
      ENABLE_REDIS: ${ENABLE_REDIS:-true}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}

      # Optional Keycloak OIDC integration
      KEYCLOAK_ENABLED: ${KEYCLOAK_ENABLED:-false}
      KEYCLOAK_URL: ${KEYCLOAK_URL:-http://keycloak:8080}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-fundamental}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID:-}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET:-}
      KEYCLOAK_ISSUER: ${KEYCLOAK_ISSUER:-}
      KEYCLOAK_SCOPES: ${KEYCLOAK_SCOPES:-openid profile email}
    env_file:
      - .env
    ports:
      - "8000:8000"
    # Redis and Postgres are optional - removed depends_on to allow service to start without them
    # If you want to use PostgreSQL, set FUNDAMENTAL_DATABASE_URL in .env or environment
    # If you want to use Redis, ensure the redis service is running and ENABLE_REDIS=true
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8000/health | grep -q 'ok'"]
      interval: 30s
      timeout: 5s
      retries: 5

  fundamental-web:
    build:
      context: ../web
      dockerfile: ../infra/Dockerfile.web
    container_name: fundamental-web
    restart: unless-stopped
    environment:
      NODE_ENV: development
      NEXT_TELEMETRY_DISABLED: "1"
      NPM_CONFIG_LOGLEVEL: warn
      PORT: "3000"
      # Backend API URL (used by server-side API routes)
      BACKEND_URL: ${BACKEND_URL:-http://fundamental-backend:8000}
    ports:
      - "3000:3000"
    depends_on:
      - fundamental-backend

  # Optional Redis service - only needed if ENABLE_REDIS=true
  # The application will work without Redis (library scanning features will be disabled)
  redis:
    image: redis:8.4.0
    container_name: fundamental-redis
    restart: unless-stopped
    command: redis-server ${REDIS_PASSWORD:+--requirepass ${REDIS_PASSWORD}}
    ports:
      - "6379:6379"
    env_file:
      - .env
    profiles:
      - redis  # Use 'docker-compose -f docker-compose.dev.yaml --profile redis up' to include Redis

  # Optional PostgreSQL service - only needed if you want to use PostgreSQL instead of SQLite
  # The application defaults to SQLite if FUNDAMENTAL_DATABASE_URL is not set
  # To use PostgreSQL, set FUNDAMENTAL_DATABASE_URL=postgresql+psycopg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
  postgres:
    image: postgres:18.1-alpine3.22
    container_name: fundamental-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-admin123}
      POSTGRES_DB: ${POSTGRES_DB:-fundamental}
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-admin} -d ${POSTGRES_DB:-fundamental}" ]
      interval: 30s
      timeout: 10s
      retries: 5
    volumes:
      - postgres_data:/var/lib/postgresql/data
    profiles:
      - postgres  # Use 'docker-compose -f docker-compose.dev.yaml --profile postgres up' to include PostgreSQL

  keycloak:
    image: quay.io/keycloak/keycloak:26.0.0
    container_name: fundamental-keycloak
    restart: unless-stopped
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin123}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/keycloak
      KC_DB_USERNAME: ${KEYCLOAK_DB_USER:-keycloak}
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak123}
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
    ports:
      - "${KEYCLOAK_PORT:-8080}:8080"
    depends_on:
      keycloak-db:
        condition: service_healthy
    profiles:
      - keycloak  # Use 'docker-compose -f docker-compose.dev.yaml --profile keycloak up' to include Keycloak

  keycloak-db:
    image: postgres:18.1-alpine3.22
    container_name: fundamental-keycloak-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${KEYCLOAK_DB_USER:-keycloak}
      POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak123}
      POSTGRES_DB: keycloak
    ports:
      - "${KEYCLOAK_DB_PORT:-5433}:5432"
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    profiles:
      - keycloak
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${KEYCLOAK_DB_USER:-keycloak} -d keycloak"]
      interval: 30s
      timeout: 10s
      retries: 5

volumes:
  postgres_data:
  keycloak_db_data:
