---
services:
  bookcard-backend:
    build:
      context: ..
      dockerfile: infra/Dockerfile.backend
    container_name: bookcard-backend
    restart: unless-stopped
    environment:
      # backend authentication settings
      BOOKCARD_JWT_SECRET: ${BOOKCARD_JWT_SECRET:-youShouldChangeThis}
      BOOKCARD_JWT_ALG: ${BOOKCARD_JWT_ALG:-HS256}
      BOOKCARD_JWT_EXPIRES_MIN: ${BOOKCARD_JWT_EXPIRES_MIN:-131400}  # 3 months
      BOOKCARD_ALEMBIC_ENABLED: ${BOOKCARD_ALEMBIC_ENABLED:-true}
      # Database URL - defaults to SQLite if postgres service is not available
      # Set BOOKCARD_DATABASE_URL to use PostgreSQL, or leave unset for SQLite
      BOOKCARD_DATABASE_URL: ${BOOKCARD_DATABASE_URL:-}

      # library administration settings
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@example.com}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin123}

      # Key used for storing user-provided passwords and tokens.
      BOOKCARD_FERNET_KEY: ${BOOKCARD_FERNET_KEY:-EifxhGYj-u0JolSrDhBLqyIZSnoZCVKOAFQbuv70T08=}  # yamllint disable-line rule:line-length

      # Redis configuration for distributed workers (optional)
      # Set ENABLE_REDIS=false to disable Redis features
      # If Redis service is available, it will be used automatically
      ENABLE_REDIS: ${ENABLE_REDIS:-true}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}

      # Optional OIDC integration
      OIDC_ENABLED: ${OIDC_ENABLED:-false}
      OIDC_ISSUER: ${OIDC_ISSUER:-}
      OIDC_CLIENT_ID: ${OIDC_CLIENT_ID:-}
      OIDC_CLIENT_SECRET: ${OIDC_CLIENT_SECRET:-}
      OIDC_SCOPES: ${OIDC_SCOPES:-openid profile email}
    env_file:
      - .env
    ports:
      - "8000:8000"
    # Redis and Postgres are optional - removed depends_on to allow service
    # to start without them
    # If you want to use PostgreSQL, set BOOKCARD_DATABASE_URL in .env
    # or environment
    # If you want to use Redis, ensure the redis service is running
    # and ENABLE_REDIS=true
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8000/health | grep -q 'ok'"]  # yamllint disable-line rule:line-length
      interval: 30s
      timeout: 5s
      retries: 5

  bookcard-web:
    build:
      context: ../web
      dockerfile: ../infra/Dockerfile.web
    container_name: bookcard-web
    restart: unless-stopped
    environment:
      NODE_ENV: development
      NEXT_TELEMETRY_DISABLED: "1"
      NPM_CONFIG_LOGLEVEL: warn
      PORT: "3000"
      # Backend API URL (used by server-side API routes)
      BACKEND_URL: ${BACKEND_URL:-http://bookcard-backend:8000}
    ports:
      - "3000:3000"
    depends_on:
      - bookcard-backend

  # Optional Redis service - only needed if ENABLE_REDIS=true
  # The application will work without Redis
  # (library scanning features will be disabled)
  redis:
    image: redis:8.4.0
    container_name: bookcard-redis
    restart: unless-stopped
    command: redis-server ${REDIS_PASSWORD:+--requirepass ${REDIS_PASSWORD}}
    ports:
      - "6379:6379"
    env_file:
      - .env
    profiles:
      - redis

  postgres:
    image: postgres:18.1-alpine3.22
    container_name: bookcard-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-admin123}
      POSTGRES_DB: ${POSTGRES_DB:-bookcard}
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-admin} -d ${POSTGRES_DB:-bookcard}"]  # yamllint disable-line rule:line-length
      interval: 30s
      timeout: 10s
      retries: 5
    volumes:
      - postgres_data:/var/lib/postgresql/data
    profiles:
      - postgres

  # Documentation service - serves MkDocs static site
  docs:
    build:
      context: ..
      dockerfile: infra/Dockerfile.docs
    container_name: bookcard-docs
    restart: unless-stopped
    ports:
      - "${DOCS_PORT:-8080}:80"

volumes:
  postgres_data:
