services:
  fundamental:
    build:
      context: ..
      dockerfile: infra/Dockerfile
    container_name: fundamental
    restart: unless-stopped
    volumes:
      # Your books directory, typically where calibre's `metadata.db` is located
      - /path/to/books:/books:ro

      # Fundamental's data/configs directory; mount this to persist data and configs
      - ~/.fundamental:/data

      # Path to automatically ingest books from.  Files here will be automatically ingested and deleted.
      - /path/to/books/ingest:/data/books_ingest
    environment:
      PGID: ${PGID:-1000}
      PUID: ${PUID:-1000}

      # backend authentication settings
      FUNDAMENTAL_JWT_SECRET: ${FUNDAMENTAL_JWT_SECRET:-youShouldChangeThis}
      FUNDAMENTAL_JWT_ALG: ${FUNDAMENTAL_JWT_ALG:-HS256}
      FUNDAMENTAL_JWT_EXPIRES_MIN: ${FUNDAMENTAL_JWT_EXPIRES_MIN:-131400} # 3 months
      FUNDAMENTAL_ALEMBIC_ENABLED: ${FUNDAMENTAL_ALEMBIC_ENABLED:-true}
      # Database URL - defaults to SQLite if postgres service is not available
      # Set FUNDAMENTAL_DATABASE_URL to use PostgreSQL, or leave unset for SQLite
      FUNDAMENTAL_DATABASE_URL: ${FUNDAMENTAL_DATABASE_URL:-}

      # library administration settings
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@example.com}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin123}

      # Key used for storing user-provided passwords and tokens.
      # You should change this.  DO NOT use this key in production.
      # Get a key from: https://fernet.utils.com/
      # Or generate a key with: `python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"`
      FUNDAMENTAL_FERNET_KEY: ${FUNDAMENTAL_FERNET_KEY:-EifxhGYj-u0JolSrDhBLqyIZSnoZCVKOAFQbuv70T08=}
      # !!! One more time: DO NOT USE THIS KEY IN PRODUCTION. !!!

      # Redis configuration for distributed workers (optional)
      # Set ENABLE_REDIS=false to disable Redis features
      # If Redis service is available, it will be used automatically
      ENABLE_REDIS: ${ENABLE_REDIS:-true}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}

      # Frontend configuration
      NODE_ENV: production
      NEXT_TELEMETRY_DISABLED: "1"
      NPM_CONFIG_LOGLEVEL: warn
      PORT: "3000"
      # Backend API URL (used by server-side API routes)
      # Since frontend and backend are in the same container, use localhost
      BACKEND_URL: ${BACKEND_URL:-http://localhost:8000}
    env_file:
      - .env
    ports:
      - "3000:3000"  # Frontend
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8000/health | grep -q 'ok' && curl -fsS http://localhost:3000 | grep -q '<!DOCTYPE html>' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - fundamental-network

  # Optional Redis service - only needed if ENABLE_REDIS=true
  # The application will work without Redis (library scanning features will be disabled)
  redis:
    image: redis:8.4.0
    container_name: fundamental-redis
    restart: unless-stopped
    command: redis-server ${REDIS_PASSWORD:+--requirepass ${REDIS_PASSWORD}}
    # ports:
    #   - "6379:6379"
    env_file:
      - .env
    networks:
      - fundamental-network

  # Optional PostgreSQL service - only needed if you want to use PostgreSQL instead of SQLite
  # The application defaults to SQLite if FUNDAMENTAL_DATABASE_URL is not set
  # To use PostgreSQL, set FUNDAMENTAL_DATABASE_URL=postgresql+psycopg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
  postgres:
    image: postgres:18.1-alpine3.22
    container_name: fundamental-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-admin123}
      POSTGRES_DB: ${POSTGRES_DB:-fundamental}
    # Port not exposed to host - only accessible within Docker network
    # Uncomment if you'd like to access the database from outside the container
    # ports:
    #   - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-admin} -d ${POSTGRES_DB:-fundamental}" ]
      interval: 30s
      timeout: 10s
      retries: 5
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - fundamental-network

networks:
  fundamental-network:
    driver: bridge

volumes:
  postgres_data:
