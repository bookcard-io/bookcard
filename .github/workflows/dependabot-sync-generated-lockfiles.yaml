---
# yamllint disable rule:line-length
name: Dependabot - Sync generated lockfiles

"on":
  pull_request:
    branches: [main]
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: write

concurrency:
  group: dependabot-sync-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  sync:
    name: Regenerate requirements*.txt (uv)
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v5
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        run: uv python install 3.12

      - name: Regenerate generated dependency files
        shell: bash
        run: |
          set -euo pipefail

          base_sha="${{ github.event.pull_request.base.sha }}"
          head_sha="${{ github.event.pull_request.head.sha }}"

          # Ensure the base commit exists locally for diffing.
          git fetch --no-tags origin "${base_sha}"

          changed="$(git diff --name-only "${base_sha}" "${head_sha}")"
          if ! printf '%s\n' "${changed}" | grep -Eq '^(pyproject\.toml|uv\.lock)$'; then
            echo "No uv inputs changed; skipping regeneration."
            exit 0
          fi

          # Keep these commands aligned with `.pre-commit-config.yaml`.
          uv pip compile --generate-hashes pyproject.toml -o requirements.txt --universal --python-version=3.12
          uv pip compile --generate-hashes pyproject.toml -o requirements-dev.txt --universal --python-version=3.12 --group=dev

      - name: Commit and push if changed
        shell: bash
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No generated changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add requirements.txt requirements-dev.txt
          git commit -m "chore(deps): regenerate requirements files"
          git push
