---
# yamllint disable rule:line-length
name: CI Frontend

"on":
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, reopened, synchronize, ready_for_review]

concurrency:
  group: ci-frontend-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      frontend_manifest: ${{ steps.filter.outputs.frontend_manifest }}
      frontend_lockfile: ${{ steps.filter.outputs.frontend_lockfile }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'web/**'
              - '.github/workflows/ci-frontend.yaml'
            frontend_manifest:
              - 'web/package.json'
            frontend_lockfile:
              - 'web/package-lock.json'

  lockfile-guard:
    name: Guard against unintended lockfile rewrites
    needs: changes
    runs-on: ubuntu-latest
    steps:
      - name: Fail if lockfile changed without manifest
        shell: bash
        run: |
          lockfile="${{ needs.changes.outputs.frontend_lockfile }}"
          manifest="${{ needs.changes.outputs.frontend_manifest }}"

          if [ "${lockfile}" = "true" ] && [ "${manifest}" != "true" ]; then
            echo "::error::web/package-lock.json changed without web/package.json."
            echo "::error::Use npm ci for normal development."
            echo "::error::Only change lockfile when changing dependencies."
            exit 1
          fi

  lint:
    name: Lint & Typecheck
    needs: [changes, lockfile-guard]
    runs-on: ubuntu-latest
    steps:
      - name: Check for frontend changes
        id: check_changes
        shell: bash
        run: |
          if [ "${{ needs.changes.outputs.frontend }}" != "true" ]; then
            echo "No frontend changes detected, skipping lint and typecheck"
          fi
          echo "has_changes=${{ needs.changes.outputs.frontend }}" \
            >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4
        if: steps.check_changes.outputs.has_changes == 'true'

      - name: Setup Node
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "22.22.0"
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install npm ^11.8.0
        if: steps.check_changes.outputs.has_changes == 'true'
        run: npm install -g "npm@^11.8.0"

      - name: Install dependencies
        if: steps.check_changes.outputs.has_changes == 'true'
        working-directory: web
        run: npm ci

      - name: Lint (Biome)
        if: steps.check_changes.outputs.has_changes == 'true'
        working-directory: web
        run: npm run lint -- --error-on-warnings

      - name: Typecheck
        if: steps.check_changes.outputs.has_changes == 'true'
        working-directory: web
        run: npm run check:types

  test-and-build:
    name: Test & Build (Node ${{ matrix.node-version }})
    needs: [changes, lockfile-guard, lint]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: ["22"]

    steps:
      - name: Check for frontend changes
        id: check_changes
        shell: bash
        run: |
          if [ "${{ needs.changes.outputs.frontend }}" != "true" ]; then
            echo "No frontend changes detected, skipping test and build"
          fi
          echo "has_changes=${{ needs.changes.outputs.frontend }}" \
            >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4
        if: steps.check_changes.outputs.has_changes == 'true'

      - name: Setup Node ${{ matrix.node-version }}
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install npm ^11.8.0
        if: steps.check_changes.outputs.has_changes == 'true'
        run: npm install -g "npm@^11.8.0"

      - name: Install dependencies
        if: steps.check_changes.outputs.has_changes == 'true'
        working-directory: web
        run: npm ci

      - name: Install Playwright browsers
        if: steps.check_changes.outputs.has_changes == 'true'
        working-directory: web
        run: npx playwright install --with-deps chromium

      - name: Run tests
        if: steps.check_changes.outputs.has_changes == 'true'
        working-directory: web
        run: npm run test:coverage

      - name: Build
        if: steps.check_changes.outputs.has_changes == 'true'
        working-directory: web
        run: npm run build
